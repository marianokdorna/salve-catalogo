<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Catálogo de Productos de Salve de Vero</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal-backdrop { background: rgba(0,0,0,0.4); }
    .input { @apply border rounded-lg px-3 py-2 w-full; }
    .btn { @apply px-4 py-2 rounded-xl shadow text-sm font-medium; }
    .btn-primary { @apply bg-pink-600 text-white hover:bg-pink-700; }
    .btn-secondary { @apply bg-gray-200 hover:bg-gray-300; }
    .table-header { @apply text-xs font-semibold text-gray-600 uppercase; }
  </style>
</head>
<body class="bg-pink-50 text-gray-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6 flex items-center justify-between gap-4 bg-white p-4 rounded-2xl shadow">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-2xl font-bold text-pink-700">Catálogo de Productos de Salve de Vero</h1>
          <p class="text-sm text-gray-600">Conectado a Google Sheets (JSONP) — Buscar, agregar y modificar</p>
        </div>
      </div>
      <div class="text-xs text-gray-600">Registros: <span id="dbgCount">0</span></div>
    </header>

    <section class="grid md:grid-cols-3 gap-4 mb-4">
      <div class="bg-white p-4 rounded-2xl shadow">
        <label class="text-sm font-semibold">Buscar por Código (exacto)</label>
        <input id="buscarCodigo" class="input mt-1" placeholder="Ej: PUB1013" />
      </div>
      <div class="bg-white p-4 rounded-2xl shadow">
        <label class="text-sm font-semibold">Buscar por Nombre (contiene)</label>
        <input id="buscarNombre" class="input mt-1" placeholder="Ej: bolsa, aceite, crema ..." />
      </div>
      <div class="bg-white p-4 rounded-2xl shadow flex items-end gap-2">
        <button id="btnBuscar" class="btn btn-primary">Buscar</button>
        <button id="btnLimpiar" class="btn btn-secondary">Limpiar</button>
        <button id="btnAgregar" class="btn">➕ Agregar</button>
      </div>
    </section>

    <section class="bg-white rounded-2xl shadow">
      <div class="overflow-auto">
        <table class="min-w-full border-collapse">
          <thead class="bg-pink-100">
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="tbody" class="divide-y"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between p-3">
        <div class="text-sm text-gray-600">
          <span id="status">0 registros</span>
        </div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="btn btn-secondary">Anterior</button>
          <span id="pageInfo" class="text-sm"></span>
          <button id="nextPage" class="btn btn-secondary">Siguiente</button>
          <select id="pageSize" class="input w-28">
            <option value="10">10 / pág.</option>
            <option value="25" selected>25 / pág.</option>
            <option value="50">50 / pág.</option>
            <option value="100">100 / pág.</option>
          </select>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative bg-white rounded-2xl shadow-xl w-[95vw] max-w-3xl p-6">
      <h2 id="modalTitle" class="text-xl font-semibold mb-4">Editar registro</h2>
      <form id="formRegistro" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></form>
      <div class="flex justify-end gap-2">
        <button id="btnCancelar" class="btn btn-secondary" type="button">Cancelar</button>
        <button id="btnGuardar" class="btn btn-primary" type="button">Guardar</button>
      </div>
    </div>
  </div>

<script>
// === CONFIG ===
const API_URL = "https://script.google.com/macros/s/AKfycbzAJLEIeoA8a1J4edVnmOba-3SFStvg6hRgR8k0Nq2WFwOzdDbRX1m3U3pYaeqD7WnD/exec"; // /exec o script.googleusercontent.com/...

// === Utilidades ===
function normalizeHeader(h) { return String(h || '').trim(); }
function toStr(v) { return (v === null || v === undefined) ? '' : String(v); }
function containsCI(haystack, needle) { return toStr(haystack).toLowerCase().includes(toStr(needle).toLowerCase()); }
function equalsCI(a, b) { return toStr(a).trim().toLowerCase() === toStr(b).trim().toLowerCase(); }

// === Estado ===
let data = [];
let filtered = [];
let headers = [];
let editingRecord = null;
let page = 1;
let pageSize = 25;

// === JSONP generic loader ===
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = 'cb_' + Date.now().toString(36) + Math.random().toString(36).slice(2);
    const s = document.createElement('script');
    window[cb] = (payload) => {
      try { resolve(payload); }
      finally { delete window[cb]; s.remove(); }
    };
    s.onerror = () => { delete window[cb]; s.remove(); reject(new Error('JSONP error')); };
    s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
    document.body.appendChild(s);
  });
}

// === Carga inicial ===
window.addEventListener('DOMContentLoaded', async () => {
  try {
    const datos = await jsonp(API_URL);
    data = datos; filtered = datos; headers = inferHeaders(datos);
    page = 1; renderTable(); updateStatus();
    document.getElementById('dbgCount').textContent = String(datos.length);
  } catch (e) {
    alert('❌ No pude cargar datos: ' + e.message);
    console.error(e);
  }
});

// === Inferir headers priorizando campos comunes ===
const PREFERRED = ["Código","Nombre","Rubro","Sub Rubro","Precio","Precio Revendedora","Rango","Cantidad","Clienta"];
function inferHeaders(rows){
  if (!rows || rows.length === 0) return [];
  const all = Object.keys(rows[0]);
  const prefer = PREFERRED.filter(h => all.some(k => equalsCI(k,h)));
  const rest = all.filter(k => !prefer.some(h => equalsCI(h,k)));
  const resolved = [];
  prefer.forEach(h => { const f = all.find(k => equalsCI(k,h)); if (f) resolved.push(f); });
  resolved.push(...rest);
  return resolved.map(normalizeHeader);
}

// === Búsqueda ===
async function applyFilters() {
  const codigo = document.getElementById('buscarCodigo').value.trim();
  const nombre = document.getElementById('buscarNombre').value.trim();
  try {
    let url = API_URL;
    if (codigo) url += (url.includes('?')?'&':'?') + 'codigo=' + encodeURIComponent(codigo);
    else if (nombre) url += (url.includes('?')?'&':'?') + 'nombre=' + encodeURIComponent(nombre);
    const datos = await jsonp(url);
    data = datos; filtered = datos; headers = inferHeaders(datos);
    page = 1; renderTable(); updateStatus();
    document.getElementById('dbgCount').textContent = String(datos.length);
  } catch (e) {
    alert('❌ Búsqueda fallida: ' + e.message);
    console.error(e);
  }
}
document.getElementById('btnBuscar').addEventListener('click', applyFilters);
document.getElementById('btnLimpiar').addEventListener('click', () => {
  document.getElementById('buscarCodigo').value = '';
  document.getElementById('buscarNombre').value = '';
  window.location.reload();
});

// === Tabla + Paginación ===
document.getElementById('pageSize').addEventListener('change', (e)=>{ pageSize = parseInt(e.target.value,10) || 25; page = 1; renderTable(); updateStatus(); });
document.getElementById('prevPage').addEventListener('click', ()=>{ if (page > 1) { page--; renderTable(); updateStatus(); } });
document.getElementById('nextPage').addEventListener('click', ()=>{ const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize)); if (page < totalPages) { page++; renderTable(); updateStatus(); } });

function renderTable() {
  const theadRow = document.getElementById('theadRow');
  const tbody = document.getElementById('tbody');
  theadRow.innerHTML = '';
  tbody.innerHTML = '';

  headers.forEach(h => { const th = document.createElement('th'); th.className = 'table-header px-3 py-2 text-left'; th.textContent = normalizeHeader(h); theadRow.appendChild(th); });
  const thAcc = document.createElement('th'); thAcc.className = 'table-header px-3 py-2 text-center'; thAcc.textContent = 'Acciones'; theadRow.appendChild(thAcc);

  const start = (page-1)*pageSize; const end = Math.min(filtered.length, start + pageSize);
  for (let i=start;i<end;i++){
    const r = filtered[i];
    const tr = document.createElement('tr');
    headers.forEach(h => { const td = document.createElement('td'); td.className = 'px-3 py-2 text-sm'; td.textContent = r[h] ?? ''; tr.appendChild(td); });
    const tdAcc = document.createElement('td'); tdAcc.className = 'px-3 py-2 text-center';
    const btnE = document.createElement('button'); btnE.className = 'btn btn-secondary'; btnE.textContent = 'Editar';
    btnE.addEventListener('click', ()=> openModalForEdit(r));
    tdAcc.appendChild(btnE); tr.appendChild(tdAcc); tbody.appendChild(tr);
  }
  const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  document.getElementById('pageInfo').textContent = `Página ${page} de ${totalPages}`;
}
function updateStatus(){ document.getElementById('status').textContent = `${filtered.length} registros (total: ${data.length})`; }

// === Modal Agregar/Editar ===
const modal = document.getElementById('modal');
const form = document.getElementById('formRegistro');
const modalTitle = document.getElementById('modalTitle');
document.getElementById('btnAgregar').addEventListener('click', ()=>{ openModalForAdd(); });
document.getElementById('btnCancelar').addEventListener('click', closeModal);
document.getElementById('btnGuardar').addEventListener('click', saveModal);

function openModalForAdd(){
  editingRecord = null;
  modalTitle.textContent = 'Agregar registro';
  renderFormFields({});
  openModal();
}
function openModalForEdit(record){
  editingRecord = record;
  modalTitle.textContent = 'Editar registro';
  renderFormFields(record);
  openModal();
}
function openModal(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
function closeModal(){ modal.classList.add('hidden'); modal.classList.remove('flex'); }

function renderFormFields(record){
  form.innerHTML = '';
  headers.forEach(h => {
    const div = document.createElement('div');
    const label = document.createElement('label');
    label.className = 'text-sm font-semibold';
    label.textContent = normalizeHeader(h);
    const input = document.createElement('input');
    input.className = 'input mt-1';
    input.value = record[h] ?? '';
    input.dataset.header = h;
    if (["Precio","Precio Revendedora","Cantidad","Rango"].some(n => equalsCI(n,h))) { input.type = 'number'; input.step = 'any'; }
    div.appendChild(label); div.appendChild(input); form.appendChild(div);
  });
}

// === Guardar por JSONP (accion=upsert) ===
async function saveModal(){
  const inputs = form.querySelectorAll('input[data-header]');
  const rec = {};
  inputs.forEach(inp => rec[inp.dataset.header] = inp.value);

  if (!rec['Código'] && !Object.keys(rec).some(k => equalsCI(k,'Código'))) {
    alert('El campo "Código" es obligatorio.');
    return;
  }

  // construir URL de upsert con todos los campos
  let url = API_URL + (API_URL.includes('?') ? '&' : '?') + 'accion=upsert';
  Object.keys(rec).forEach(k => {
    url += '&' + encodeURIComponent(k) + '=' + encodeURIComponent(rec[k] ?? '');
  });

  try {
    const res = await jsonp(url); // {status: "Creado" | "Actualizado"}
    alert('✅ ' + (res && res.status ? res.status : 'Guardado'));
    // refrescar con filtros actuales o todo
    const codigo = document.getElementById('buscarCodigo').value.trim();
    const nombre = document.getElementById('buscarNombre').value.trim();
    let reload = API_URL;
    if (codigo) reload += (reload.includes('?')?'&':'?') + 'codigo=' + encodeURIComponent(codigo);
    else if (nombre) reload += (reload.includes('?')?'&':'?') + 'nombre=' + encodeURIComponent(nombre);
    const datos = await jsonp(reload);
    data = datos; filtered = datos; headers = inferHeaders(datos);
    page = 1; renderTable(); updateStatus();
    closeModal();
  } catch (e) {
    alert('❌ No pude guardar: ' + e.message);
    console.error(e);
  }
}
</script>
</body>
</html>

